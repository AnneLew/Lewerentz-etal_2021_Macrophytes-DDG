---
title: "DDG Analysis | Main results"
author: "Anne Lewerentz, Juliano Cabral"
date: "12 Juni 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=FALSE, warning=FALSE, dpi=300)
```

```{r load-packages, include=FALSE}
#Load packages
library(dplyr)
library(ggplot2)
library(magrittr)
library(knitr)
library(MacrophytesDDG)
library(ggpubr)
library(data.table)
#library(corrplot)
library(kableExtra)
library(knitr)

```

## Data overview

```{r, echo=FALSE}

complete<-MakrophS_ALL %>% 
  dplyr::summarise(N = n_distinct(Lake,YEAR),Lakes_N = n_distinct(Lake),Transects_N = n_distinct(MST_NR),Depths_N =n_distinct(Probestelle),Years_N = n_distinct(YEAR))

Level1<-MakrophS_ALL %>% filter(datasettot=="LEVEL3") %>% #group_by(datasettot) %>% 
  dplyr::summarise(N = n_distinct(Lake,YEAR),Lakes_N = n_distinct(Lake),Transects_N = n_distinct(MST_NR),Depths_N = n_distinct(Probestelle),Years_N = n_distinct(YEAR))

# Level2_3<-MakrophS_ALL %>% filter(datasettot=="LEVEL3"|datasettot=="LEVEL2") %>% 
#   dplyr::summarise(N = n_distinct(Lake,YEAR),Lakes_N = n_distinct(Lake),Transects_N = n_distinct(MST_NR),Depths_N = n_distinct(Probestelle),Years_N = n_distinct(YEAR))

Level_Timeseries<-MakrophS_ALL %>% group_by(Lake)%>%filter(n_distinct(YEAR)>3)%>% ungroup() %>%
  dplyr::summarise(N = n_distinct(Lake,YEAR),Lakes_N = n_distinct(Lake),Transects_N = n_distinct(MST_NR),Depths_N = n_distinct(Probestelle),Years_N = n_distinct(YEAR))


Level<- rbind(complete,Level1,Level_Timeseries)
Level$dataset<-c("Biotic","Biotic+Abiotic", "Timeseries")
Level[,c(6,1,2,3,4,5)]
```


## Depth diversity gradients : Full datasets

```{r, echo=FALSE}
A1<-ggplot(data=Makroph_Lake_DepthS)+
  geom_line(aes(x=Tiefe, y=ALPHA, group=interaction(Lake, YEAR)),col="grey")+ scale_x_reverse()+
  geom_line(data=Makroph_Depth,aes(x=(Tiefe), y=mAlpha))+ 
  geom_errorbar(data=Makroph_Depth,aes(x=(Tiefe),ymin=mAlpha-sdAlpha, ymax=mAlpha+sdAlpha), width=.1)+
  ylab("Alpha richness")+xlab(("Depth (m)"))
B1<-ggplot(data=Makroph_Lake_DepthS)+
  geom_line(aes(x=Tiefe, y=BETA, group=interaction(Lake, YEAR)),col="grey")+ scale_x_reverse()+
  geom_line(data=Makroph_Depth,aes(x=(Tiefe), y=mBeta))+ 
  geom_errorbar(data=Makroph_Depth,aes(x=(Tiefe),ymin=mBeta-sdBeta, ymax=mBeta+sdBeta), width=.1)+
  ylab("Beta richness")+xlab(("Depth (m)"))
C1<-ggplot(data=Makroph_Lake_DepthS)+
  geom_line(aes(x=Tiefe, y=GAMMA, group=interaction(Lake, YEAR)),col="grey")+ scale_x_reverse()+
  geom_line(data=Makroph_Depth,aes(x=(Tiefe), y=mGamma))+ 
  geom_errorbar(data=Makroph_Depth,aes(x=(Tiefe),ymin=mGamma-sdGamma, ymax=mGamma+sdGamma), width=.1)+
  ylab("Gamma richness")+xlab(("Depth (m)"))
ggarrange(A1,B1,C1,ncol=3,nrow=1,labels="auto")
```

## Pattern analysis



```{r}

PEAK$DepthGroup<-if_else(PEAK$AlphaPeakDepth>-1,"Decreasing curve (Peak: >-1m)",
                                  if_else(PEAK$AlphaPeakDepth>-2,"Hump-shaped (Peak: -1- -2m)",
                                          if_else(PEAK$AlphaPeakDepth>-4,"Hump-shaped (Peak -2- -4m)","Increasing curve (Peak: <-4m)")))

PEAKCLASSAlpha<-PEAK %>% group_by(DepthGroup) %>% dplyr::summarise(Alpha_N=n_distinct(interaction(Lake,YEAR)))


PEAKCLASS2<-PEAK  %>% group_by(GammaPeakDepth) %>% dplyr::summarise(datasets=n_distinct(interaction(Lake,YEAR))) 
PEAKCLASS2$DepthGroup<-if_else(PEAKCLASS2$GammaPeakDepth>-1,"Decreasing curve (Peak: >-1m)",
                                  if_else(PEAKCLASS2$GammaPeakDepth>-2,"Hump-shaped (Peak: -1- -2m)",
                                          if_else(PEAKCLASS2$GammaPeakDepth>-4,"Hump-shaped (Peak -2- -4m)","Increasing curve (Peak: <-4m)")))
PEAKCLASSGamma<-PEAKCLASS2 %>% group_by(DepthGroup) %>% dplyr::summarise(Gamma_N=sum(datasets))

PEAKCLASS3<-PEAK %>% group_by(BetaPeakDepth) %>% dplyr::summarise(datasets=n_distinct(interaction(Lake,YEAR)))
PEAKCLASS3$DepthGroup<-if_else(PEAKCLASS3$BetaPeakDepth>-1,"Decreasing curve (Peak: >-1m)",
                                  if_else(PEAKCLASS3$BetaPeakDepth>-2,"Hump-shaped (Peak: -1- -2m)",
                                          if_else(PEAKCLASS3$BetaPeakDepth>-4,"Hump-shaped (Peak -2- -4m)","Increasing curve (Peak: <-4m)")))
PEAKCLASSBeta<-PEAKCLASS3 %>% group_by(DepthGroup) %>% dplyr::summarise(Beta_N=sum(datasets))



transpose(left_join(left_join(PEAKCLASSAlpha,PEAKCLASSBeta, by="DepthGroup"),PEAKCLASSGamma,by="DepthGroup"), keep.names = "col", make.names = "DepthGroup")


#chisq.test(PEAKCLASS1$`n_distinct(interaction(Lake, YEAR))`)
```



```{r Peak plots, echo=FALSE}
## PEAK Plot
PPalpha<-ggplot(PEAK, aes(y=AlphaPeakRichness, x=AlphaPeakDepth, col=datasettotsimpl))+
  geom_point()+# labs(col = "Pattern type")+
  xlab(expression(D[alpha][max](m)))+ylab(expression(R[alpha][max](N)))+
  theme(legend.position = c(0.9, 0.2))+ scale_x_reverse()

PPbeta<-ggplot(PEAK, aes(x=BetaPeakDepth, y=BetaPeakRichness, col=datasettotsimpl))+geom_point()+ scale_x_reverse()+
  xlab(expression(D[beta][max](m)))+ylab(expression(R[beta][max](N)))

PPgamma<-ggplot(PEAK, aes(x=GammaPeakDepth, y=GammaPeakRichness, col=datasettotsimpl))+geom_point()+ scale_x_reverse()+
  xlab(expression(D[gamma][max](m)))+ylab(expression(R[gamma][max](N)))

ggarrange(PPalpha,PPbeta,PPgamma, ncol=3,common.legend = T, legend="bottom", labels="auto")
```


## DRIVERS





```{r PCA, echo=FALSE}
################ PCA ###############################################
library(ggbiplot)

label_lake<- PEAK_Chem_norm[complete.cases(PEAK_Chem_norm[,c(3:16,19)]),] #LEVEL 3 data #19 #
lak.pca <- prcomp(na.omit(label_lake[,c(3:16,19)]),center = TRUE, scale. = TRUE)
#print(lak.pca)
#plot(lak.pca, type="l")
#summary(lak.pca) 

# p1<- ggbiplot(lak.pca, choices = 1:2, obs.scale = 1, var.scale = 1,labels=label_lake$Lake, arrow.color = "#FF0000",
#          #groups = group_lake_withoutSAK, 
#          ellipse = TRUE, cicle = TRUE) #+ xlim(-4,4) +ylim(-4,4)
# p2<- ggbiplot(lak.pca, choices = 3:4, obs.scale = 1, var.scale = 1,labels=label_lake$Lake, arrow.color = "#FF0000",
#          #groups = group_lake_withoutSAK, 
#          ellipse = TRUE, cicle = TRUE) #+ xlim(-4,4) +ylim(-4,4)
# figure <- ggarrange(p1,p2,
#                     #widths = c(2.3,2),heights = c(1.1,1,1,1.2),
#                     labels = c("A","B"),
#                     #label.x = c(0.18,0,0.18,0,0.18,0,0.18,0),label.y = c(0.8,0.8,1,1,1,1,1,1),
#                     ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom", align = "hv")
#figure

PCA <- (data.frame(label_lake$Lake))
PCA$YEAR <- label_lake$YEAR
PCA$Morph_PC1 <- lak.pca$x[,1]
PCA$Morph_PC2 <- lak.pca$x[,2]
PCA$Morph_PC3 <- lak.pca$x[,3]
PCA$Morph_PC4 <- lak.pca$x[,4]
PCA$Morph_PC5 <- lak.pca$x[,5]
names(PCA)[1]<-"Lake"


PEAK_PCA<-merge(PCA, PEAK_Chem_norm, by=c("Lake", "YEAR"))


### Figure about PCA loadings
#print(lak.pca)

par(mfrow=c(1,5))
axis1<-barplot(lak.pca$rotation[,1], main="PC1", las=2,horiz = TRUE)
axis2<-barplot(lak.pca$rotation[,2], main="PC2", yaxt='n',horiz = TRUE)
axis3<-barplot(lak.pca$rotation[,3], main="PC3", yaxt='n',horiz = TRUE)
axis4<-barplot(lak.pca$rotation[,4], main="PC4", yaxt='n',horiz = TRUE)
axis4<-barplot(lak.pca$rotation[,5], main="PC5",yaxt='n',horiz = TRUE)
```




```{r GAMM, echo=FALSE}
library(gamm4)
gam_AlphaPeakDepth <- gamm4((AlphaPeakDepth) ~ s(Morph_PC2)+s(Morph_PC4),
                            random= ~(1|Lake), # package gamm4
                            data=PEAK_PCA)

summary(gam_AlphaPeakDepth$gam)

gam_AlphaPeakRichness <- gamm4(AlphaPeakRichness ~ s(Morph_PC1),
                               random= ~(1|Lake), # package gamm4
                               data=PEAK_PCA)

summary(gam_AlphaPeakRichness$gam)
par(mfrow=c(1,1))


par(mfrow=c(1,3))
plot(gam_AlphaPeakDepth$gam,residuals=TRUE, main = expression(D[alpha][max]), shade = T,seWithMean=T)
plot(gam_AlphaPeakRichness$gam,residuals=TRUE, main = expression(R[alpha][max]), shade = T,seWithMean=T)


```



## Temporal change



```{r Linear models, echo=FALSE, message=FALSE, warning=FALSE}
#library(broom) # Package would help to do the following easier. Found it too late.

PEAK_LAKE_ALL<-PEAK_LAKE_ALL %>%mutate(YEAR=as.numeric(YEAR))


GammaModel<-PEAK_LAKE_ALL%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3) %>% 
  do({
    mod = lm(GAMMA ~ YEAR, data = .)
    data.frame(Slope = coef(mod)[2],pValue=lmp(mod))
  }) %>% plyr::rename(c("Slope"="GammaSlope", "pValue"="GammaPValue"))

AlphaPeakRichnessModel<-PEAK_LAKE_ALL%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3) %>% 
  do({
    mod = lm(AlphaPeakRichness ~ YEAR, data = .)
    data.frame(Slope = coef(mod)[2],pValue=lmp(mod))
  }) %>% plyr::rename(c("Slope"="AlphaPeakRichnessSlope", "pValue"="AlphaPeakRichnessPValue"))

AlphaPeakDepthModel<-PEAK_LAKE_ALL%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3) %>% 
  do({
    mod = lm(AlphaPeakDepth ~ YEAR, data = .)
    data.frame(Slope = coef(mod)[2],pValue=lmp(mod))
  }) %>% plyr::rename(c("Slope"="AlphaPeakDepthSlope", "pValue"="AlphaPeakDepthPValue"))

AlphaPeakModel <- merge (AlphaPeakDepthModel, AlphaPeakRichnessModel, by="Lake")


BetaPeakRichnessModel<-PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3) %>% 
  do({
    mod = lm(BetaPeakRichness ~ YEAR, data = .)
    data.frame(Slope = coef(mod)[2],pValue=lmp(mod))
  }) %>% plyr::rename(c("Slope"="BetaPeakRichnessSlope", "pValue"="BetaPeakRichnessPValue"))

BetaPeakDepthModel<-PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3) %>% 
  do({
    mod = lm(BetaPeakDepth ~ YEAR, data = .)
    data.frame(Slope = coef(mod)[2],pValue=lmp(mod))
  }) %>% plyr::rename(c("Slope"="BetaPeakDepthSlope", "pValue"="BetaPeakDepthPValue"))

BetaPeakModel <- merge (BetaPeakDepthModel, BetaPeakRichnessModel, by="Lake")

GammaPeakRichnessModel<-PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3) %>% 
  do({
    mod = lm(GammaPeakRichness ~ YEAR, data = .)
    data.frame(Slope = coef(mod)[2],pValue=lmp(mod))
  }) %>% plyr::rename(c("Slope"="GammaPeakRichnessSlope", "pValue"="GammaPeakRichnessPValue"))

GammaPeakDepthModel<-PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3) %>% 
  do({
    mod = lm(GammaPeakDepth ~ YEAR, data = .)
    data.frame(Slope = coef(mod)[2],pValue=lmp(mod))
  }) %>% plyr::rename(c("Slope"="GammaPeakDepthSlope", "pValue"="GammaPeakDepthPValue"))

GammaPeakModel <- merge (GammaPeakDepthModel, GammaPeakRichnessModel, by="Lake")

PeakModel <- merge (AlphaPeakModel,BetaPeakModel,by="Lake")
PeakModel <- merge (PeakModel,GammaPeakModel,by="Lake")

Model <- merge (GammaModel,PeakModel,by="Lake")

ModelT<-Model %>% mutate(GammaTrend=ifelse(Model$GammaSlope>0,"+",ifelse(Model$GammaSlope<0,"-","0"))) %>%
  mutate(GammapV=ifelse(GammaPValue<0.001,"***",ifelse(GammaPValue<0.01,"**",ifelse(GammaPValue<0.05,"*",ifelse(GammaPValue<0.1,".","NA")))))%>%
  
  mutate(AlphaPeakDepthTrend=ifelse(Model$AlphaPeakDepthSlope>0.5*0,"+",ifelse(Model$AlphaPeakDepthSlope<0,"-","0"))) %>%
  mutate(AlphaPeakDepthpV=ifelse(AlphaPeakDepthPValue<0.001,"***",ifelse(AlphaPeakDepthPValue<0.01,"**",ifelse(AlphaPeakDepthPValue<0.05,"*",ifelse(AlphaPeakDepthPValue<0.1,".","NA")))))%>%
  
  mutate(AlphaPeakRichnessTrend=ifelse(Model$AlphaPeakRichnessSlope>0,"+",ifelse(Model$AlphaPeakRichnessSlope<0,"-","0")))%>%
  mutate(AlphaPeakRichnesspV=ifelse(AlphaPeakRichnessPValue<0.001,"***",ifelse(AlphaPeakRichnessPValue<0.01,"**",ifelse(AlphaPeakRichnessPValue<0.05,"*",ifelse(AlphaPeakRichnessPValue<0.1,".","NA")))))%>%
  
  mutate(BetaPeakDepthTrend=ifelse(Model$BetaPeakDepthSlope>0,"+",ifelse(Model$BetaPeakDepthSlope<0,"-","0"))) %>%
  mutate(BetaPeakDepthpV=ifelse(BetaPeakDepthPValue<0.001,"***",ifelse(BetaPeakDepthPValue<0.01,"**",ifelse(BetaPeakDepthPValue<0.05,"*",ifelse(BetaPeakDepthPValue<0.1,".","NA")))))%>%
  
  mutate(BetaPeakRichnessTrend=ifelse(Model$BetaPeakRichnessSlope>0,"+",ifelse(Model$BetaPeakRichnessSlope<0,"-","0")))%>%
  mutate(BetaPeakRichnesspV=ifelse(BetaPeakRichnessPValue<0.001,"***",ifelse(BetaPeakRichnessPValue<0.01,"**",ifelse(BetaPeakRichnessPValue<0.05,"*",ifelse(BetaPeakRichnessPValue<0.1,".","NA")))))%>%
  
  mutate(GammaPeakDepthTrend=ifelse(Model$GammaPeakDepthSlope>0,"+",ifelse(Model$GammaPeakDepthSlope<0,"-","0"))) %>%
  mutate(GammaPeakDepthpV=ifelse(GammaPeakDepthPValue<0.001,"***",ifelse(GammaPeakDepthPValue<0.01,"**",ifelse(GammaPeakDepthPValue<0.05,"*",ifelse(GammaPeakDepthPValue<0.1,".","NA")))))%>%
  
  
  mutate(GammaPeakRichnessTrend=ifelse(Model$GammaPeakRichnessSlope>0,"+",ifelse(Model$GammaPeakRichnessSlope<0,"-","0")))%>%
  mutate(GammaPeakRichnesspV=ifelse(GammaPeakRichnessPValue<0.001,"***",ifelse(GammaPeakRichnessPValue<0.01,"**",ifelse(GammaPeakRichnessPValue<0.05,"*",ifelse(GammaPeakRichnessPValue<0.1,".","NA")))))


ModelTshort<-ModelT[c(1,16:29)] %>% 
  tidyr::unite(GammaLM, c("GammaTrend", "GammapV"))%>% 
  tidyr::unite(AlphaPeakDepthLM, c("AlphaPeakDepthTrend", "AlphaPeakDepthpV"))%>% 
  tidyr::unite(AlphaPeakRichnessLM, c("AlphaPeakRichnessTrend", "AlphaPeakRichnesspV"))%>% 
  tidyr::unite(BetaPeakDepthLM, c("BetaPeakDepthTrend", "BetaPeakDepthpV"))%>% 
  tidyr::unite(BetaPeakRichnessLM, c("BetaPeakRichnessTrend", "BetaPeakRichnesspV"))%>% 
  tidyr::unite(GammaPeakDepthLM, c("GammaPeakDepthTrend", "GammaPeakDepthpV"))%>% 
  tidyr::unite(GammaPeakRichnessLM, c("GammaPeakRichnessTrend", "GammaPeakRichnesspV"))

ModelTshort <- data.frame(lapply(ModelTshort, function(x) {gsub("_NA", "", x)}))
ModelTshort <- data.frame(lapply(ModelTshort, function(x) {gsub("_", "", x)}))

ModelTshort
#ModelTshort<-transpose(ModelTshort, keep.names = "col", make.names = "Lake")

#colnames(ModelTshort)<-c("Lake","Gamma Trend","D~$\\alpha$max~ Trend","R~$\\alpha$max~ Trend", "D~$\\beta$max~ Trend","R~$\\beta$max~ Trend", "D~$\\gamma$max~ Trend","R~$\\gamma$max~ Trend")
#, col.names = c("Lake","Gamma Trend","D~$\\alpha$max~ Trend","R~$\\alpha$max~ Trend", "D~$\\beta$max~ Trend","R~$\\beta$max~ Trend", "D~$\\gamma$max~ Trend","R~$\\gamma$max~ Trend")

#greeks=c(alpha='\u03b1', tau='\u03c4', sigma='\u03c3',beta='\u03b2',gamma='\u03b3',sigmaSq='\u03c3\u00B2')
#knitr::kable(ModelTshort, "html") %>%kable_styling("striped", full_width = F) 


```



```{r Variability, echo=FALSE,fig.height=2, fig.width=10}


LAKECHANGE<-PEAK%>% dplyr::group_by(Lake) %>%
   dplyr::summarise(NYEAR=n_distinct(YEAR),
             AlphaPeakDepthmean=mean(AlphaPeakDepth),AlphaPeakDepthRange=max(AlphaPeakDepth)-min(AlphaPeakDepth),
             AlphaPeakDepthsd=sd(AlphaPeakDepth),
             AlphaPeakRichnessnmean=mean(AlphaPeakRichness),AlphaPeakRichnessRange=max(AlphaPeakRichness)-min(AlphaPeakRichness),
             BetaPeakDepthmean=mean(BetaPeakDepth),BetaPeakDepthRange=max(BetaPeakDepth)-min(BetaPeakDepth), 
             BetaPeakRichnessnmean=mean(BetaPeakRichness),BetaPeakRichnessRange=max(BetaPeakRichness)-min(BetaPeakRichness),
             GammaPeakDepthmean=mean(GammaPeakDepth),GammaPeakDepthRange=max(GammaPeakDepth)-min(GammaPeakDepth),
             GammaPeakDepthsd=sd(GammaPeakDepth),
             GammaPeakRichnessnmean=mean(GammaPeakRichness),GammaPeakRichnessRange=max(GammaPeakRichness)-min(GammaPeakRichness)
             )%>%
   filter(NYEAR>3)

 LAKECHANGE2<-LAKECHANGE %>%
   mutate(APeakDepthRangeClass=ifelse(AlphaPeakDepthRange<1,"0-1m",ifelse(AlphaPeakDepthRange<2,"1-2m",ifelse(AlphaPeakDepthRange<3,"2-3m",
                               ifelse(AlphaPeakDepthRange<4,"3-4m",ifelse(AlphaPeakDepthRange<5,"4-5m",99))))),
          BPeakDepthRangeClass=ifelse(BetaPeakDepthRange<1,"0-1m",ifelse(BetaPeakDepthRange<2,"1-2m",ifelse(BetaPeakDepthRange<3,"2-3m",
                               ifelse(BetaPeakDepthRange<4,"3-4m",ifelse(BetaPeakDepthRange<5,"4-5m",99))))),
          GPeakDepthRangeClass=ifelse(GammaPeakDepthRange<1,"0-1m",ifelse(GammaPeakDepthRange<2,"1-2m",ifelse(GammaPeakDepthRange<3,"2-3m",
                               ifelse(GammaPeakDepthRange<4,"3-4m",ifelse(GammaPeakDepthRange<5,"4-5m",99))))))

AA<-LAKECHANGE2%>%group_by(APeakDepthRangeClass)%>%dplyr::summarise(AlphaPeakDepthRange=n_distinct(Lake))%>%
   dplyr::rename(PeakDepthRangeClass=APeakDepthRangeClass)
BA<-LAKECHANGE2%>%group_by(BPeakDepthRangeClass)%>%dplyr::summarise(BetaPeakDepthRange=n_distinct(Lake))%>%
   dplyr::rename(PeakDepthRangeClass=BPeakDepthRangeClass)
GA<-LAKECHANGE2%>%group_by(GPeakDepthRangeClass)%>%dplyr::summarise(GammaPeakDepthRange=n_distinct(Lake))%>%
  dplyr::rename(PeakDepthRangeClass=GPeakDepthRangeClass)

 AB<-full_join(AA,BA,by=c("PeakDepthRangeClass"))
 ABG<-full_join(AB,GA,by=c("PeakDepthRangeClass"))
 ABGs<-ABG %>% tidyr::gather("Type", "Nlakes", -PeakDepthRangeClass)

 positions <- c("GammaPeakDepthRange","BetaPeakDepthRange", "AlphaPeakDepthRange" )
 ggplot(ABGs,aes(x=(Type),y=Nlakes,fill=PeakDepthRangeClass))+
   #geom_bar(stat="identity") +
   geom_col(position = position_stack(reverse = TRUE))+
   xlab("")+ylab("Lakes (N)")+
   #theme(axis.text.x = element_text(angle = 90, hjust = 1))+
   coord_flip()+
   scale_x_discrete(limits = positions)
```

