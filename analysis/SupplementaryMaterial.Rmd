---
title: "DDG Analysis | Supplementary Material"
author: "Anne Lewerentz, Juliano S. Cabral"
date: "14 Juni 2020"
output:
  word_document: default
  html_document:
    toc: true
    number_sections: true
    fig_caption: true
    df_print: paged
    code_folding: hide
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r load-packages, include=FALSE}
#Load packages
library(dplyr)
library(ggplot2)
library(magrittr)
library(knitr)
library(MacrophytesDDG)
library(ggpubr)
#library(corrplot)

```



#H1 Pattern
## Depth diversity gradients of macrophytes - overview

Depth pattern of Alpha, Beta and Gamma Richness for full dataset. For Alpha Richness, lines show the mean Alpha Richness per lake and year with their corresponding standard deviation; the single Richness Peaks are depicted as points. The different dataset levels can be distinguished by line type and point shape: Points and dashed line=Biotic dataset of all available macrophyte mapping; triangles and solid line=subset of biotic dataset, where also abiotic data is available. 

```{r DDG, fig.height=6, fig.width=12}
### ALPHA & Peak Plot
ggplot(data=Makroph_Lake_DepthS, aes(x=(Tiefe), y=ALPHA, col=factor(YEAR), group=interaction(Lake,YEAR)))+ 
  geom_line(aes(linetype=datasettotsimpl))+#interaction(dataset,datasetWLF)
  scale_linetype_manual(values=c("dotted", "solid"))+
  facet_wrap(~ Lake, ncol=7)+
  ylab("Alpha richness")+ xlab("")+labs(fill = "Pattern type")+ylim(0,15)+
  geom_errorbar(data=Makroph_Lake_DepthS,aes(ymin=ALPHA-ALPHAsd, ymax=ALPHA+ALPHAsd), width=.1)+
  geom_point(data=PEAK, aes(x=(AlphaPeakDepth), y=AlphaPeakRichness, shape=datasettotsimpl))+ scale_x_reverse()+
    labs(linetype="Peak dataset type",shape="DDG dataset type", colour="Year")
### BETA & Peak Plot
ggplot(Makroph_Lake_DepthS, aes(x=Tiefe, y=BETA, group=interaction(Lake,YEAR), col=factor(YEAR), linetype=datasettotsimpl))+ 
  geom_line()+facet_wrap(~ Lake, ncol=7)+
  scale_linetype_manual(values=c("dotted", "solid"))+
  ylab("Beta richness")+ xlab("Depth (m)")+labs(fill = "Pattern type")+
  geom_point(data=PEAK, aes(x=BetaPeakDepth, y=BetaPeakRichness, shape=datasettotsimpl))+ scale_x_reverse()+
    labs(linetype="Peak dataset type",shape="DDG dataset type", colour="Year")
### GAMMA & Peak Plot
ggplot(Makroph_Lake_DepthS, aes(x=Tiefe, y=GAMMA, group=interaction(Lake,YEAR), col=factor(YEAR), linetype=datasettotsimpl))+ 
  geom_line()+facet_wrap(~ Lake, ncol=7)+
  scale_linetype_manual(values=c("dotted", "solid"))+
  ylab("Gamma richness")+ xlab("Depth (m)")+labs(fill = "Pattern type")+
  geom_point(data=PEAK, aes(x=GammaPeakDepth, y=GammaPeakRichness, shape=datasettotsimpl))+ scale_x_reverse()+
    labs(linetype="Peak dataset type",shape="DDG dataset type", colour="Year")

```


## Correlations between metrices

Correlations between diversity metrices #TODO Umbenennen! # Problem with greek letters
```{r}
library(PerformanceAnalytics)
chart.Correlation(PEAK_Chem_norm[c(33,20,22,31,32,29,30)], histogram=F, pch=9, method = "pearson")
```






#H2 Driver
## Correlations | Drivers
Correlation between normalized chemical-physical values (!Achtung Level2 Dataset) & Richness measures #TODO: umbenennen: Greek letters?

```{r, fig.width=14, fig.height=10}
library(PerformanceAnalytics)
chart.Correlation(PEAK_Chem_norm[c(33,20,22,31,32,29,30,16,19,3:15)], histogram=F, pch=9, method = "pearson")

```

## Environmental fitting
Als Erg√§nzende Analyse #TODO Umbenennen
Environmental fitting for normalized abiotic data and scales DDG measures
Dalphamax & Ralphamax
```{r,fig.height=5, fig.width=5}
library(vegan)
ord <- PEAK_Chem_norm[c(25,26)]
vec.sp_Alpha<-envfit(ord, PEAK_Chem_norm[c(16,19,3:15)], permu = 999,na.rm = TRUE)#26:38,
vec.sp_Alpha
vec.sp.df_Alpha<-as.data.frame(vec.sp_Alpha$vectors$arrows*sqrt(vec.sp_Alpha$vectors$r))
vec.sp.df_Alpha$param<-rownames(vec.sp.df_Alpha)
vec.sp.df_Alpha <- vec.sp.df_Alpha %>% filter(param %in% (c("Area_ha","WLF","Conduct","NH4N","NO3N","O2diss","Ptot","SiO2","Tempsd","Transp","SAC")))#"Temp_0_6_sd",
ggplot(PEAK_Chem_norm, aes(y=AlphaPeakDepth_sc, x=AlphaPeakRichness_sc))+
  geom_point(aes())+  theme(legend.title=element_blank())+#scale_fill_discrete(name = "Groups")+
  geom_segment(data=vec.sp.df_Alpha,aes(y=0,yend=2*AlphaPeakDepth_sc,x=0,xend=2*AlphaPeakRichness_sc),
               arrow = arrow(length = unit(0.5, "cm")),colour="black",inherit_aes=FALSE) +
  geom_text(data=vec.sp.df_Alpha,aes(y=2.3*AlphaPeakDepth_sc,x=2.3*AlphaPeakRichness_sc,label=param),size=5)+
  coord_fixed()  + xlab("Ralphamax (scaled)")  + ylab("Dalphamax (scaled)")+
  theme(legend.position = c(0.9, 0.1))

```
Dbetamax & Rbetamax
```{r,fig.height=5, fig.width=5}


ord <- scale(PEAK_Chem_norm[c(31,32)])
vec.sp_Beta<-envfit(ord, PEAK_Chem_norm[c(16,19,3:15)], permu = 999,na.rm = TRUE)#26:38,
vec.sp_Beta
vec.sp.df_Beta<-as.data.frame(vec.sp_Beta$vectors$arrows*sqrt(vec.sp_Beta$vectors$r))
vec.sp.df_Beta$param<-rownames(vec.sp.df_Beta)
vec.sp.df_Beta <- vec.sp.df_Beta %>% filter(param %in% (c("Area_ha")))#"Temp_0_6_sd",
ggplot(PEAK_Chem_norm, aes(y=scale(BetaPeakDepth), x=scale(BetaPeakRichness)))+
  geom_point(aes())+  theme(legend.title=element_blank())+#scale_fill_discrete(name = "Groups")+
  geom_segment(data=vec.sp.df_Beta,aes(y=0,yend=2*(BetaPeakDepth),x=0,xend=2*(BetaPeakRichness)),
               arrow = arrow(length = unit(0.5, "cm")),colour="black",inherit_aes=FALSE) +
  geom_text(data=vec.sp.df_Beta,aes(y=2.3*(BetaPeakDepth),x=2.3*(BetaPeakRichness),label=param),size=5)+
  coord_fixed()  + xlab("Rbetamax (scaled)")  + ylab("Dbetamax (scaled)")+
  theme(legend.position = c(0.9, 0.1))

```



Dgammamax & Rgammamax
```{r,fig.height=5, fig.width=5}

ord <- scale(PEAK_Chem_norm[c(29,30)])
vec.sp_Gamma<-envfit(ord, PEAK_Chem_norm[c(16,19,3:15)], permu = 999,na.rm = TRUE)#26:38,
vec.sp_Gamma
vec.sp.df_Gamma<-as.data.frame(vec.sp_Gamma$vectors$arrows*sqrt(vec.sp_Gamma$vectors$r))
vec.sp.df_Gamma$param<-rownames(vec.sp.df_Gamma)
vec.sp.df_Gamma <- vec.sp.df_Gamma %>% filter(param %in% (c("Area_ha","WLF","NH4N","NO3N","SAC")))#"Temp_0_6_sd",
ggplot(PEAK_Chem_norm, aes(y=scale(GammaPeakDepth), x=scale(GammaPeakRichness)))+
  geom_point(aes())+  theme(legend.title=element_blank())+#scale_fill_discrete(name = "Groups")+
  geom_segment(data=vec.sp.df_Gamma,aes(y=0,yend=2*(GammaPeakDepth),x=0,xend=2*(GammaPeakRichness)),
               arrow = arrow(length = unit(0.5, "cm")),colour="black",inherit_aes=FALSE) +
  geom_text(data=vec.sp.df_Gamma,aes(y=2.3*(GammaPeakDepth),x=2.3*(GammaPeakRichness),label=param),size=5)+
  coord_fixed()  + xlab("Rgammamax (scaled)")  + ylab("Dgammamax (scaled)")+
  theme(legend.position = c(0.9, 0.1))
```


## Represetitvity of small dataset

Comparing the environmental data for the two dataset levels Level3 and Level2 with a permanova test shows that Level3 data (N=27) is highly significant (p<0.001) representative for full dataset.  

```{r}
##TEST for Represantativity #Permanova
adonis2(PEAK[,c(3,5)]~datasettotsimpl, data=PEAK, by = NULL) #ALPHAPEAK
adonis2(PEAK[,c(14,15)]~datasettotsimpl, data=PEAK, by = NULL) #GammaPEAK
#adonis2(PEAK[,c(16,17)]~datasettotsimpl, data=PEAK, by = NULL) #BetaPEAK
```
No significant inpluence of dataset type

## PCA
PCA for all abiotic data. Multiple years for lakes
```{r}
library(ggbiplot)

label_lake<- PEAK_Chem_norm[complete.cases(PEAK_Chem_norm[,c(3:16,19)]),] #LEVEL 3 data #19 #
lak.pca <- prcomp(na.omit(label_lake[,c(3:16,19)]),center = TRUE, scale. = TRUE)
#print(lak.pca)
#plot(lak.pca, type="l")
summary(lak.pca) 

p1<- ggbiplot(lak.pca, choices = 1:2, obs.scale = 1, var.scale = 1,labels=label_lake$Lake, arrow.color = "#FF0000",
         ellipse = TRUE, cicle = TRUE)
p2<- ggbiplot(lak.pca, choices = 3:4, obs.scale = 1, var.scale = 1,labels=label_lake$Lake, arrow.color = "#FF0000",
         ellipse = TRUE, cicle = TRUE) 
figure <- ggarrange(p1,p2,
                    labels = c("A","B"),
                    ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom", align = "hv")
figure

# PCA <- (data.frame(label_lake$Lake))
# PCA$YEAR <- label_lake$YEAR
# PCA$Morph_PC1 <- lak.pca$x[,1]
# PCA$Morph_PC2 <- lak.pca$x[,2]
# PCA$Morph_PC3 <- lak.pca$x[,3]
# PCA$Morph_PC4 <- lak.pca$x[,4]
# PCA$Morph_PC5 <- lak.pca$x[,5]
# names(PCA)[1]<-"Lake"


```



#H3 Temporal change

## Gamma change
Temporal change of Gamma richness for Temporal change dataset
```{r, fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
library(ggpmisc)
ggplot(PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3), aes(x=factor(YEAR), y=GAMMA, group=factor(Lake))) +
  xlab("")+ylab("GAMMA richness")+theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_point(alpha = 0.3) +facet_wrap(vars(Lake),nrow=3) +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               label.x.npc = "left", label.y.npc = 0.15,
               formula = formula, parse = TRUE, size = 3)+
  stat_fit_glance(method = 'lm',
                  method.args = list(formula = formula),
                  geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                  label.x = 'left', label.y = 0.35, size = 3)
```


## Peak change

Temporal change for Dalphamax and Ralphamax

```{r Temporal plots, fig.height=10, fig.width=12, message=FALSE, warning=FALSE}
library(ggpmisc)

T1<-ggplot(PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3), aes(x=factor(YEAR), y=AlphaPeakDepth, group=factor(Lake)))+
  xlab("")+ylab("AlphaPeakDepth")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
  geom_point(alpha = 0.3) +facet_wrap(vars(Lake),nrow=3) +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               label.x.npc = "left", label.y.npc = 0.15,
               formula = formula, parse = TRUE, size = 3)+
  stat_fit_glance(method = 'lm',
                  method.args = list(formula = formula),
                  geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                  label.x = 'left', label.y = -3.8, size = 3)



T2<-ggplot(PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3), aes(x=factor(YEAR), y=AlphaPeakRichness, group=factor(Lake)))+
  xlab("")+ylab("AlphaPeakRichness")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
  geom_point(alpha = 0.3) +facet_wrap(vars(Lake),nrow=3) +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               label.x.npc = "left", label.y.npc = 0.15,
               formula = formula, parse = TRUE, size = 3)+
  stat_fit_glance(method = 'lm',
                  method.args = list(formula = formula),
                  geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                  label.x = 'left', label.y = -3.8, size = 3)

ggarrange(T1,T2, nrow=2)
```




Temporal change for Dbetamax and Rbetamax

```{r Tempral plots, fig.height=10, fig.width=12, message=FALSE, warning=FALSE}
T3<-ggplot(PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3), aes(x=factor(YEAR), y=BetaPeakDepth, group=factor(Lake)))+
  xlab("")+ylab("BetaPeakDepth")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
  geom_point(alpha = 0.3) +facet_wrap(vars(Lake),nrow=3) +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               label.x.npc = "left", label.y.npc = 0.15,
               formula = formula, parse = TRUE, size = 3)+
  stat_fit_glance(method = 'lm',
                  method.args = list(formula = formula),
                  geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                  label.x = 'left', label.y = -3.8, size = 3)

T4<-ggplot(PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3), aes(x=factor(YEAR), y=BetaPeakRichness, group=factor(Lake)))+
  xlab("")+ylab("BetaPeakRichness")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
  geom_point(alpha = 0.3) +facet_wrap(vars(Lake),nrow=3) +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               label.x.npc = "left", label.y.npc = 0.15,
               formula = formula, parse = TRUE, size = 3)+
  stat_fit_glance(method = 'lm',
                  method.args = list(formula = formula),
                  geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                  label.x = 'left', label.y = -3.8, size = 3)

ggarrange(T3,T4, nrow=2)


```


Temporal change for Dgammamax and Rgammamax
```{r, fig.height=10, fig.width=12, message=FALSE, warning=FALSE}
T5<-ggplot(PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3), aes(x=factor(YEAR), y=GammaPeakDepth, group=factor(Lake)))+
  xlab("")+ylab("GammaPeakDepth")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
  geom_point(alpha = 0.3) +facet_wrap(vars(Lake),nrow=3) +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               label.x.npc = "left", label.y.npc = 0.15,
               formula = formula, parse = TRUE, size = 3)+
  stat_fit_glance(method = 'lm',
                  method.args = list(formula = formula),
                  geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                  label.x = 'left', label.y = -3.8, size = 3)

T6<-ggplot(PEAK%>%group_by(Lake)%>%filter(n_distinct(YEAR)>3), aes(x=factor(YEAR), y=GammaPeakRichness, group=factor(Lake)))+
  xlab("")+ylab("GammaPeakRichness")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
  geom_point(alpha = 0.3) +facet_wrap(vars(Lake),nrow=3) +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               label.x.npc = "left", label.y.npc = 0.15,
               formula = formula, parse = TRUE, size = 3)+
  stat_fit_glance(method = 'lm',
                  method.args = list(formula = formula),
                  geom = 'text',
                  aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                  label.x = 'left', label.y = -3.8, size = 3)

ggarrange(T5,T6, nrow=2)
```


## Abiotic change
```{r, fig.height=14, fig.width=12, }

Chem_0_6m_mean_STAFF <- Chem_uniform_LOIx[rowSums(is.na(Chem_uniform_LOIx[,c(3:15)]))==0,] %>% 
  group_by(Lake) %>%
  filter(n_distinct(YEAR)>1)
  
STAFF1<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=Chloride, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF2<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=Conduct, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF3<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=Ntot, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF4<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=NH4N, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF5<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=NO3N, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF6<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=O2diss, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF7<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=pH, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF7A<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=Ptot, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))

STAFF8<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=SiO2, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF9<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=Temp, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF10<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=Transp, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("YEAR")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF11<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=SAC, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("YEAR")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
STAFF12<-ggplot(Chem_0_6m_mean_STAFF,aes(x=factor(YEAR), y=Tempsd, group=(Lake), col=Lake))+
  geom_line()+geom_point()+xlab("YEAR")+theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggarrange(STAFF1,STAFF2,STAFF3,STAFF4,STAFF5,STAFF6,STAFF7,STAFF7A,STAFF8,STAFF9,STAFF10,STAFF11,STAFF12, nrow = 5, ncol = 3, common.legend = TRUE, legend = "bottom", align = "hv")

```

